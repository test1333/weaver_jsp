<%@ page language="java" contentType="text/html; charset=UTF-8" %>
<%@ page import="java.io.File"%> 
<%@ page import="weaver.general.Util"%> 
<%@ page import="weaver.conn.RecordSet"%>
<%@ page import="java.io.FileInputStream"%>
<%@ page import="java.io.FileOutputStream"%>
<%@ page import="org.apache.axis.encoding.Base64"%>
<%@ page import="sun.misc.BASE64Decoder"%>
<%@ page import="weaver.docs.webservices.DocAttachment"%>
<%@ page import="weaver.docs.webservices.DocInfo"%>
<%@ page import="weaver.conn.RecordSetDataSource"%>
<%@ page import="weaver.docs.webservices.DocServiceImpl"%>
<%@ page import="weaver.hrm.User"%>
<%@ page import="java.io.InputStream"%>
<%@ page import="java.sql.Connection"%>
<%@ page import="java.sql.ResultSet"%>
<%@ page import="weaver.interfaces.datasource.DataSource"%>
<%@ page import="java.io.ByteArrayOutputStream"%>
<%@ page import="java.io.*"%>
<%@ page import="weaver.general.StaticObj"%>
<%@ page import="java.sql.*"%>
	
<jsp:useBean id="rs" class="weaver.conn.RecordSet" scope="page" />
<jsp:useBean id="ra" class="weaver.conn.RecordSet" scope="page" />
<%!
	public void toImage(String image, String path) {      
		if (image != null) {    
			saveToImgFile(image.replaceAll(" ", "").replace("<", "").replace(">", "").toUpperCase(), path);    
		}  
	}  
%>
<%!
	public void saveToImgFile(String src,String output){    
		if(src==null||src.length()==0){    
			return;    
		}    
		try{    
			FileOutputStream out = new FileOutputStream(new File(output));    
			byte[] bytes = src.getBytes();    
			for(int i=0;i<bytes.length;i+=2){    
				out.write(charToInt(bytes[i])*16+charToInt(bytes[i+1]));    
			}    
			out.close();    
		}catch(Exception e){    
			e.printStackTrace();    
		}    
	}  
%>
<%!
	public int charToInt(byte ch){    
		int val = 0;    
		if(ch>=0x30&&ch<=0x39){    
			val=ch-0x30;    
		}else if(ch>=0x41&&ch<=0x46){    
			val=ch-0x41+10;    
		}    
		return val;    
	} 
%>
<%!
	public String getImageID(String name,String path){
		String uploadBuffer = "";
		try {
			FileInputStream fi = new FileInputStream(new File(path));
			ByteArrayOutputStream baos = new ByteArrayOutputStream(); 
			byte[] buffer = new byte[1024]; 
			int count = 0; 
			while((count = fi.read(buffer)) >= 0){ 
			        baos.write(buffer, 0, count); 
			} 
			uploadBuffer = new String(Base64.encode(baos.toByteArray()));
		} catch (Exception e) {
			e.printStackTrace();
		}
		String docID = getDocId(name,uploadBuffer,"1");
		RecordSet rs = new RecordSet();
		String sql = "select imagefileid from DocImageFile where docid = '" + docID + "'";
		rs.executeSql(sql);
		String imagefileid = "";
		if (rs.next()) {
			imagefileid = Util.null2String(rs.getString("imagefileid"));
		}
		return imagefileid;
	}
%>
<%!
	public String getDocId(String name, String value,String createrid){
		String docId = "";
		String imagefileid = "";
		try {
			DocInfo di = new DocInfo();
			di.setMaincategory(0);
			di.setSubcategory(0);
			di.setSeccategory(50);	
			di.setDocSubject(name.substring(0, name.lastIndexOf(".")));	
			DocAttachment doca = new DocAttachment();
			doca.setFilename(name);
			byte[] buffer = new BASE64Decoder().decodeBuffer(value);
			String encode = Base64.encode(buffer);
			doca.setFilecontent(encode);
			DocAttachment[] docs = new DocAttachment[1];
			docs[0] = doca;
			di.setAttachments(docs);
			String departmentId = "-1";
			User user = new User();
			user.setUid(Integer.parseInt(createrid));
			user.setUserDepartment(Integer.parseInt(departmentId));
			user.setLanguage(7);
			user.setLogintype("1");
			user.setLoginip("127.0.0.1");
			DocServiceImpl ds = new DocServiceImpl();
		
			docId = String.valueOf(ds.createDocByUser(di, user));
			out.println("docid:"+docId);
			RecordSet rs = new RecordSet();
			String sql = "select imagefileid from DocImageFile where docid = '" + docId + "'";
			rs.executeSql(sql);
			if (rs.next()) {
				imagefileid = Util.null2String(rs.getString("imagefileid"));
			}
			
			if(imagefileid.length() >2){
				rs.executeSql("update hrmresource set resourceimageid =" +imagefileid + " where workcode = '" + name.replaceAll(".jpg", "") + "'" );
			}
			
		} catch (Exception e) {
			e.printStackTrace();
		}
		return imagefileid;
	}
%>

<%
//	String dateid = "SSH";
//	String sh = "FFD8FFE1E38145786966000049492A00080000000A000E0102000B000000860000000F0102000600000091000000100102000E000000970000001A01050001000000A50000001B01050001000000AD000000280103000100000002000000310102000E000000B50000003201020014000000C30000001302030001000000020000006987040001000000D70000001BE3000020202020202020202020004E494B4F4E00434F4F4C504958205336333030002C010000010000002C010000010000007777772E6D656974752E636F6D00323031343A31313A31382030393A34363A33330024009A820500010000008D0200009D820500010000009502000022880300010000000200000027880300010000009001000030880300010000000100000000900700040000003032333003900200140000009D0200000490020014000000B10200000191070004000000010203000291050001000000C502000004920A0001000000CD0200000592050001000000D50200000792030001000000050000000892030001000000000000000992030001000000100000000A92050001000000DD0200007C92070000E00000E50200008692070010000000E5E2000000A00700040000003031303001A00300010000000100000002A00400010000000012000003A0040001000000800D000005A0040001000000FDE2000000A30700010000000300000001A30700010000000100000001A40300010000000000000002A40300010000000000000003A40300010000000000000004A4050001000000F5E2000005A40300010000001900000006A40300010000000200000007A40300010000000100000008A40300010000000000000009A4030001000000000000000AA4030001000000000000000CA403000100000000000000000000000A0000002C010000200000000A000000323031343A31313A31382030393A34363A333300323031343A31313A31382030393A34363A3333000200000001000000030000000A000000210000000A00000094110000E80300004E696B6F6E000200000049492A00080000002C0001000700040000000002000002000300020000000000000003000200080000001E020000040002000800000026020000050002000E0000002E02000006000200080000003C02000007000200080000004402000008000200080000004C0200000A00050001000000540200000B00080001000000000000000F000200080000005E0200001000070002000000000000001100040001000000D20800001A000200280000006C020000210007006A000000940200002600030012000000FE020000270007000E000000220300002C000700CE000000300300002D00030002000000000100002E000300010000000100000030000300010000000000000035000700080000000604000036000700060000000E040000380007000A0000001404000039000700500000001E0400003A000700080000006E040000800002000E0000007604000085000500010000008404000086000500010000008C0400008800070004000000000001008F000200100000009804000091000700D4030000AA04000094000800010000000000000095000200060000007E0800009B00010002000000000000009C00020014000000860800009D00030001000000000000009E0003000A0000009C0800009F0008000100000000000000AC0002000C000000B2080000B20002000A000000BE080000B5000300010000001210000000F00700040000000000000001F00400010000000000000000000000434F4C4F522000004E4F524D414C00004155544F202020202020202000004155544F2020000041462D53202000002020202020202000531E0000E803000000004155544F202000000000000000002020202020202020202020202020202020202020202020202020202020202020202020202020202000024001F000010087003E003D003D0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000003031303205004001F000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000303130310000000030313030000030313030000000000000313130300200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030313030000000004E4F524D414C20202020202020000000000000000000640000006400000001000000202020202020202020202020202020000000000000011100000000000000000000000000000000000002BC006700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000300000400000500000600000700000800000900000A00000B00000C00000D00000E00000F00001000001100001200001300001400001500001600001700001800001900001A00001B00001C00001D00001E00001F00002000002100002200002300002400002500002600002700002800002900002A00002B00002C00002D00002E00002F00003000003100003200003300003400003500003600003700003800003900003A00003B00003C00003D00003E00003F00004000004100004200004300004400004500004600004700004800004900004A00004B00004C00004D00004E00004F00005000005100005200005300005400005500005600005700005800005900005A00005B00005C00005D00005E00005F00006000006100006200006300006400006500006600006700006800006900006A00006B00006C00006D00006E00006F00007000007100007200007300007400007500007600007700007800007900007A00007B00007C00007D00007E00007F00008000008100008200008300008400008500008600008700008800008900008A00008B00008C00008D00008E00008F00009000009100009200009300009400009500009600009700009800009900009A00009B00009C00009D00009E00009F0000A00000A10000A20000A30000A40000A50000A60000A70000A80000A90000AA0000AB0000AC0000AD0000AE0000AF0000B00000B10000B20000B30000B40000B50000B60000B70000B80000B90000BA0000BB0000BC0000BD0000BE0000BF0000C00000C10000C20000C30000C40000C50000C60000C70000C80000C90000CA0000CB0000CC0000CD0000CE0000CF0000D00000D10000D20000D30000D40000D50000D60000D70000D80000D90000DA0000DB0000DC0000DD0000DE0000DF0000E00000E10000E20000E30000E40000E50000E60000E70000E80000E90000EA0000EB0000EC0000ED0000EE0000EF0000F00000F10000F20000F30000F40000F50000F60000F70000F80000F90000FA0000FB0000FC0000FD0000FE0000FF00004F46462000000000202020202020202020202020202020202020202000000000000000000000000000000000000000000000000056522D4F4E202020202000004E4F524D414C202000000000000000000000000007000301030001000000060000001A010500010000002C0900001B010500010000003409000028010300010000000200000001020400010000004609000002020400010000003A900000130203000100000002000000000000002C010000010000002C0100000100000000000000000000000000FFD8FFDB008400020102020201020202020302020304060404030304080506040609080A0A090809090A0C0F0D0A0B0E0B09090D120D0E0F101111110A0C13141210140F1011100102030304030407040407100B090B1010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010FFC401A20000010501010101010100000000000000000102030405060708090A0B0100030101010101010101010000000000000102030405060708090A0B100002010303020403050504040000017D01020300041105122131410613516107227114328191A1082342B1C11552D1F02433627282090A161718191A25262728292A3435363738393A434445464748494A535455565758595A636465666768696A737475767778797A838485868788898A92939495969798999AA2A3A4A5A6A7A8A9AAB2B3B4B5B6B7B8B9BAC2C3C4C5C6C7C8C9CAD2D3D4D5D6D7D8D9DAE1E2E3E4E5E6E7E8E9EAF1F2F3F4F5F6F7F8F9FA1100020102040403040705040400010277000102031104052131061241510761711322328108144291A1B1C109233352F0156272D10A162434E125F11718191A262728292A35363738393A434445464748494A535455565758595A636465666768696A737475767778797A82838485868788898A92939495969798999AA2A3A4A5A6A7A8A9AAB2B3B4B5B6B7B8B9BAC2C3C4C5C6C7C8C9CAD2D3D4D5D6D7D8D9DAE2E3E4E5E6E7E8E9EAF2F3F4F5F6F7F8F9FAFFC000110801E0028003012100021101031101FFDA000C03010002110311003F00FD1F8578AB50AF02B302C44B53C439F5A009D07153A8E0718A45A1E002453978A0070E9D681C914C131F4BDB34AC0253C0E2A6C30028A6980A297F1A18087AD03AD3E802F7A4E95002F19A38C50020CF5A05000283D68017BE4518E3340003814A0F1EF4980A29DF5A9480294F5F6AA0101E09C5283C505DC43CF340FCE989098EB41A4CA11BA1EF4D26A004A4EB4C053DA83D7AD00140A6803B514300A28401DE8ED4C03A77A3B5301050075A0053D69314805A4C60D001D6908E94AC0275A3B7BD5008452639140087904534E6801A718CD31C7E34C08251CD4120C8C52020956AB4ABD6934056997B5539D324D401A312FA0AB312F15D0739622ED53C63D2802755E41A907E740C70C83D29C2801C3D29";
//	String test = "D:\\WEAVER\\images\\test.jpg";
//	toImage(sh,test);
//	String name = "C01746.jpg";
//	String path = "D:\\WEAVER\\images\\C01746.jpg";
//	String st = getImageID(name,path);
//	out.println("st = " + st);
	
	DataSource ds = (DataSource) StaticObj.getServiceByFullname(("datasource.SSH"), DataSource.class);
	//  status < 4 and
	ra.executeSql("select workcode from hrmresource where status<5  and isnull(resourceimageid,0) < 100");
	int flag = 0;
	while(ra.next()){
		flag++;
		String code = Util.null2String(ra.getString("workcode"));
		out.println(code + " = "+flag+"<br>");
		if(code.length() < 1) continue;
		
			Connection conn = null;
			conn = ds.getConnection();	
			ResultSet rs1;
		try {
			String uploadBuffer = "";
			String sql = "select Photo from View_Employee where badge = '"+code+"'";
			if(code.length() == 6){
				sql = "select Photo from View_Employee where badge like '%"+code+"%'";
			}
			rs1 = conn.createStatement().executeQuery(sql);
			InputStream aa = null;
				if(rs1.next()){
					aa= rs1.getBinaryStream(1);
				}
			if(aa !=null){
				ByteArrayOutputStream baos = new ByteArrayOutputStream();
				
				 byte[] buffer = new byte[1024];
				 int count1 = 0;
				 while((count1 = aa.read(buffer)) >= 0){
				 baos.write(buffer, 0, count1);
				 }
				 uploadBuffer = new String(Base64.encode(baos.toByteArray()));
		//		out.println(uploadBuffer);
				String name = code + ".jpg";
				String imageFileID = getDocId(name,uploadBuffer,"1");
				conn.close();
			}
		try{
	               Thread.currentThread().sleep(500);
	        }catch(InterruptedException ie){
	        	ie.printStackTrace();
	        }
		} catch (Exception e) {
			e.printStackTrace();
			
			out.println(e.getMessage() +"<br>");
			try {
					conn.close();
				} catch (Exception e1) {
					// TODO Auto-generated catch block
					e1.printStackTrace();
				}
		}
	}
%>

