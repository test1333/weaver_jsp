ALTER view [dbo].[v_gnsbb_rkdwkp] as 
select a.requestid,case when cgdl='2' then '220205010206' when  cgdl='1' then '220205010203' when cgdl='3' then '220205010207' else '' end as zgdm,case when cgdl='2' then 'NPP零星材料入库暂估' when  cgdl='1' then 'NPP费用确认暂估' when cgdl='3' then 'NPP费用确认暂估' else '' end as zgdmmc,dbo.get_gns_fykm(isnull(a.fykm,''),a.cbzx,c.WLMC_1,'1') as fydm,(select yjcbzx from uf_cbzx where id=a.cbzx) as yjcbzx,(select name from CRM_CustomerInfo where id=a.xtgys) as gysmc ,a.xtgys,(select portalloginid from CRM_CustomerInfo where id=a.xtgys) as gysbh,(select CKMC from uf_stocks where id=a.shck) as shckmc,a.shck,'0' as type ,b.lastoperatedate as rkrq
from formtable_main_235 a,workflow_requestbase b,formtable_main_235_dt1 c 
where a.requestid=b.requestid and a.id=c.mainid and b.currentnodetype=3 and (a.requestid not in(select rid from uf_invoice_dt1 where rid is not null) or (select count(1) from 	formtable_main_273 t,formtable_main_273_dt1 t1,workflow_requestbase t2 where t.id=t1.mainid and t.requestId=t2.requestid and t2.currentnodeid in(select nodeid from uf_fprzjdpz) and t1.fphm in(select ta1.id from  uf_invoice ta1, uf_invoice_dt1 ta2 where ta1.id=ta2.mainid and ta2.rid=a.requestid))<=0) and  b.lastoperatedate<CONVERT(varchar(100),DATEADD(mm, DATEDIFF(mm,0,getdate()), 0),23)
union all
select a.requestid,case when cgdl='2' then '220205010206' when  cgdl='1' then '220205010203' when cgdl='3' then '220205010207' else '' end as zgdm,case when cgdl='2' then 'NPP零星材料入库暂估' when  cgdl='1' then 'NPP费用确认暂估' when cgdl='3' then 'NPP费用确认暂估' else '' end as zgdmmc,dbo.get_gns_fykm(isnull(a.fykm,''),a.cbzx,c.WLMC_1,'1') as fydm,(select yjcbzx from uf_cbzx where id=a.cbzx) as yjcbzx,(select name from CRM_CustomerInfo where id=a.xtgys) as gysmc ,a.xtgys,(select portalloginid from CRM_CustomerInfo where id=a.xtgys) as gysbh,(select CKMC from uf_stocks where id=a.shck) as shckmc,a.shck,'1' as type ,b.lastoperatedate as rkrq
from formtable_main_235 a,workflow_requestbase b,formtable_main_235_dt1 c 
where a.requestid=b.requestid and a.id=c.mainid and b.currentnodetype=3 and (a.requestid not in(select rid from uf_invoice_dt1 where rid is not null) or (select count(1) from 	formtable_main_273 t,formtable_main_273_dt1 t1,workflow_requestbase t2 where t.id=t1.mainid and t.requestId=t2.requestid and t2.currentnodeid in(select nodeid from uf_fprzjdpz) and t1.fphm in(select ta1.id from  uf_invoice ta1, uf_invoice_dt1 ta2 where ta1.id=ta2.mainid and ta2.rid=a.requestid))<=0) and  b.lastoperatedate>=CONVERT(varchar(100),DATEADD(mm, DATEDIFF(mm,0,getdate()), 0),23)
union all
select distinct a.requestid,case when a.cgdl='2' then '220205010206' when  a.cgdl='1' then '220205010203' when a.cgdl='3' then '220205010207' else '' end as zgdm,case when a.cgdl='2' then 'NPP零星材料入库暂估' when  a.cgdl='1' then 'NPP费用确认暂估' when a.cgdl='3' then 'NPP费用确认暂估' else '' end as zgdmmc,dbo.get_gns_fykm(isnull(a.fykm,''),a.cbzx,c.WLMC_1,'1') as fydm,(select yjcbzx from uf_cbzx where id=a.cbzx) as yjcbzx,(select name from CRM_CustomerInfo where id=a.xtgys) as gysmc ,a.xtgys,(select portalloginid from CRM_CustomerInfo where id=a.xtgys) as gysbh,(select CKMC from uf_stocks where id=a.shck) as shckmc,a.shck,'2' as type ,b.lastoperatedate as rkrq
from formtable_main_235 a,workflow_requestbase b,formtable_main_235_dt1 c ,uf_invoice_dt1 d,uf_invoice e
where a.requestid=b.requestid and a.id=c.mainid  and a.requestid=d.rid and e.id=d.mainid and b.currentnodetype=3 and  b.lastoperatedate<CONVERT(varchar(100),DATEADD(mm, DATEDIFF(mm,0,getdate()), 0),23) 
and exists(select 1 from formtable_main_273 t,formtable_main_273_dt1 t1,workflow_requestbase t2 where t.id=t1.mainid and t.requestId=t2.requestid and t2.currentnodeid in(select nodeid from uf_fprzjdpz) and t1.fphm=e.id and t.gzrq>=CONVERT(varchar(100),DATEADD(mm, DATEDIFF(mm,0,getdate()), 0),23))

